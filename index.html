<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>surfers - Generative Sequencer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            overflow-x: hidden;
            user-select: none;
        }

        .container {
            max-width: 1920px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            font-size: 1.8em;
            font-weight: 300;
            letter-spacing: 0.1em;
            color: #9765E0;
            text-transform: lowercase;
        }

        .transport-bar {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 8px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: #e0e0e0;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9em;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .btn.primary {
            background: #9765E0;
            border-color: #9765E0;
            color: #fff;
        }

        .btn.primary:hover {
            background: #534FA5;
            border-color: #534FA5;
        }

        .btn.playing {
            background: #CE95FB;
            border-color: #CE95FB;
            color: #000;
        }

        .btn.active {
            background: #00C2BA;
            border-color: #00C2BA;
            color: #000;
        }

        .tempo-display {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tempo-display span {
            color: #00C2BA;
            font-weight: 600;
            min-width: 50px;
            text-align: right;
        }

        .tempo-slider {
            width: 120px;
            height: 3px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
        }

        .tempo-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            background: #00C2BA;
            cursor: pointer;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-bottom: none;
            color: #888;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.2s;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .tab.active {
            background: rgba(151, 101, 224, 0.1);
            color: #9765E0;
            border-color: #9765E0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .global-section {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
            padding: 20px;
            margin-bottom: 20px;
        }

        .global-controls {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .channel {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
            padding: 20px;
            position: relative;
        }

        .channel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .channel-number {
            font-size: 1.5em;
            font-weight: 300;
            letter-spacing: 0.05em;
        }

        .channel.ch1 .channel-number { color: #00C2BA; }
        .channel.ch2 .channel-number { color: #CE95FB; }
        .channel.ch3 .channel-number { color: #9765E0; }
        .channel.ch4 .channel-number { color: #FFD300; }

        .channel-mute {
            padding: 4px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #888;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.2s;
        }

        .channel-mute:hover {
            border-color: rgba(255, 255, 255, 0.4);
        }

        .channel-mute.muted {
            background: rgba(255, 51, 102, 0.3);
            border-color: #ff3366;
            color: #ff3366;
        }

        .steps-container {
            margin-bottom: 20px;
        }

        .steps-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 6px;
            margin-bottom: 15px;
        }

        .step {
            aspect-ratio: 1;
            position: relative;
            cursor: pointer;
            transition: all 0.15s;
            touch-action: none;
            min-width: 40px;
            min-height: 40px;
        }

        .step-circle {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .step:hover .step-circle {
            border-color: rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.05);
        }

        .step:active .step-circle {
            transform: scale(0.95);
        }

        .ch1 .step.on .step-circle { 
            background: rgba(0, 194, 186, 0.2);
            border-color: #00C2BA;
        }
        .ch2 .step.on .step-circle { 
            background: rgba(206, 149, 251, 0.2);
            border-color: #CE95FB;
        }
        .ch3 .step.on .step-circle { 
            background: rgba(151, 101, 224, 0.2);
            border-color: #9765E0;
        }
        .ch4 .step.on .step-circle { 
            background: rgba(255, 211, 0, 0.2);
            border-color: #FFD300;
        }

        .ch1 .step.current .step-circle { 
            box-shadow: 0 0 20px rgba(0, 194, 186, 0.8);
            background: rgba(0, 194, 186, 0.3);
        }
        .ch2 .step.current .step-circle { 
            box-shadow: 0 0 20px rgba(206, 149, 251, 0.8);
            background: rgba(206, 149, 251, 0.3);
        }
        .ch3 .step.current .step-circle { 
            box-shadow: 0 0 20px rgba(151, 101, 224, 0.8);
            background: rgba(151, 101, 224, 0.3);
        }
        .ch4 .step.current .step-circle { 
            box-shadow: 0 0 20px rgba(255, 211, 0, 0.8);
            background: rgba(255, 211, 0, 0.3);
        }

        .step-velocity-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 0%;
            transition: height 0.2s;
        }

        .ch1 .step-velocity-bar { background: linear-gradient(to top, #00C2BA, transparent); }
        .ch2 .step-velocity-bar { background: linear-gradient(to top, #CE95FB, transparent); }
        .ch3 .step-velocity-bar { background: linear-gradient(to top, #9765E0, transparent); }
        .ch4 .step-velocity-bar { background: linear-gradient(to top, #FFD300, transparent); }

        .page-dots {
            display: flex;
            gap: 4px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .page-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.2s;
        }

        .ch1 .page-dot.active { background: #00C2BA; box-shadow: 0 0 8px rgba(0, 194, 186, 0.6); }
        .ch2 .page-dot.active { background: #CE95FB; box-shadow: 0 0 8px rgba(206, 149, 251, 0.6); }
        .ch3 .page-dot.active { background: #9765E0; box-shadow: 0 0 8px rgba(151, 101, 224, 0.6); }
        .ch4 .page-dot.active { background: #FFD300; box-shadow: 0 0 8px rgba(255, 211, 0, 0.6); }

        .controls-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-label {
            font-size: 0.7em;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #666;
            font-weight: 500;
        }

        .control-value {
            font-size: 0.85em;
            font-weight: 600;
        }

        .ch1 .control-value { color: #00C2BA; }
        .ch2 .control-value { color: #CE95FB; }
        .ch3 .control-value { color: #9765E0; }
        .ch4 .control-value { color: #FFD300; }

        .slider {
            width: 100%;
            height: 4px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            touch-action: none;
        }

        .ch1 .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #00C2BA;
            cursor: pointer;
            border-radius: 50%;
        }
        .ch2 .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #CE95FB;
            cursor: pointer;
            border-radius: 50%;
        }
        .ch3 .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #9765E0;
            cursor: pointer;
            border-radius: 50%;
        }
        .ch4 .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #FFD300;
            cursor: pointer;
            border-radius: 50%;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #9765E0;
            cursor: pointer;
            border-radius: 50%;
        }

        .slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #9765E0;
            cursor: pointer;
            border-radius: 50%;
            border: none;
        }

        select {
            width: 100%;
            padding: 6px 8px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
            font-family: inherit;
            font-size: 0.85em;
            cursor: pointer;
        }

        .btn-reseed {
            width: 100%;
            padding: 8px;
            margin-top: 10px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #888;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.2s;
        }

        .ch1 .btn-reseed:hover { 
            border-color: #00C2BA;
            color: #00C2BA;
            background: rgba(0, 194, 186, 0.05);
        }
        .ch2 .btn-reseed:hover { 
            border-color: #CE95FB;
            color: #CE95FB;
            background: rgba(206, 149, 251, 0.05);
        }
        .ch3 .btn-reseed:hover { 
            border-color: #9765E0;
            color: #9765E0;
            background: rgba(151, 101, 224, 0.05);
        }
        .ch4 .btn-reseed:hover { 
            border-color: #FFD300;
            color: #FFD300;
            background: rgba(255, 211, 0, 0.05);
        }

        .synth-section {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
            padding: 20px;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.2em;
            font-weight: 300;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            margin-bottom: 20px;
            color: #9765E0;
        }

        .synth-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .synth-channel {
            padding: 15px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .synth-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .mixer-section {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
            padding: 20px;
            margin-bottom: 20px;
        }

        .mixer-channels {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .mixer-channel {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .fader-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .fader {
            -webkit-appearance: slider-vertical;
            writing-mode: bt-lr;
            height: 120px;
            width: 3px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
        }

        .ch1 .fader::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 10px;
            background: #00C2BA;
            cursor: pointer;
        }
        .ch2 .fader::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 10px;
            background: #CE95FB;
            cursor: pointer;
        }
        .ch3 .fader::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 10px;
            background: #9765E0;
            cursor: pointer;
        }
        .ch4 .fader::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 10px;
            background: #FFD300;
            cursor: pointer;
        }

        .fx-section {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
            padding: 20px;
        }

        .fx-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .fx-unit {
            padding: 20px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .fx-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .fx-title {
            font-size: 1em;
            font-weight: 500;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .fx-toggle {
            padding: 4px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #666;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.2s;
        }

        .fx-toggle.active {
            background: rgba(151, 101, 224, 0.2);
            border-color: #9765E0;
            color: #9765E0;
        }

        .macro-section {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
            padding: 20px;
            margin-bottom: 20px;
        }

        .macro-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .macro-controls {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 20px;
        }

        .ratchet-control {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1a1a1a;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 30px;
            max-width: 600px;
            width: 90%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-title {
            font-size: 1.3em;
            color: #9765E0;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 1.5em;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: #fff;
        }

        .scale-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .scale-note {
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.15);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.2s;
        }

        .scale-note:hover {
            border-color: rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.1);
        }

        .scale-note.active {
            background: rgba(151, 101, 224, 0.3);
            border-color: #9765E0;
            color: #9765E0;
        }

        @media (max-width: 1400px) {
            .main-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 800px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .synth-grid,
            .mixer-channels,
            .fx-grid,
            .macro-grid,
            .macro-controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">surfers</div>
            <div class="transport-bar">
                <button class="btn primary" id="playBtn">▶ Play</button>
                <button class="btn" id="stopBtn">■ Stop</button>
                <div class="tempo-display">
                    <span id="tempoDisplay">120</span> BPM
                    <input type="range" class="tempo-slider" id="tempo" min="40" max="240" value="120">
                </div>
                <button class="btn" id="reseedAll">⟲ Reseed All</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="sequencer">Sequencer</button>
            <button class="tab" data-tab="synth">Synthesizer</button>
            <button class="tab" data-tab="mixer">Mixer</button>
            <button class="tab" data-tab="fx">Effects</button>
            <button class="tab" data-tab="macro">Macro</button>
        </div>

        <div class="tab-content active" id="sequencer-tab">
            <div class="global-section">
                <div class="section-title">Global Settings</div>
                <div class="global-controls">
                    <div class="control-group">
                        <div class="control-label">Scale</div>
                        <select id="globalScale">
                            <option value="chromatic">Chromatic</option>
                            <option value="major" selected>Major</option>
                            <option value="minor">Minor</option>
                            <option value="majorPent">Major Pent</option>
                            <option value="minorPent">Minor Pent</option>
                            <option value="harmonicMinor">Harmonic Minor</option>
                            <option value="wholeTone">Whole Tone</option>
                            <option value="custom">Custom...</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <div class="control-label">Root</div>
                        <div class="control-value" id="globalRootDisplay">C4</div>
                        <input type="range" class="slider" id="globalRoot" 
                               min="48" max="72" value="60">
                    </div>
                </div>
            </div>

            <div class="main-grid" id="channelsContainer"></div>
        </div>

        <div class="tab-content" id="synth-tab">
            <div class="synth-section">
                <div class="section-title">Synthesizer</div>
                <div class="synth-grid" id="synthGrid"></div>
            </div>
        </div>

        <div class="tab-content" id="mixer-tab">
            <div class="mixer-section">
                <div class="section-title">Mixer</div>
                <div class="mixer-channels" id="mixerGrid"></div>
            </div>
        </div>

        <div class="tab-content" id="fx-tab">
            <div class="fx-section">
                <div class="section-title">Effects</div>
                <div class="fx-grid" id="fxGrid"></div>
            </div>
        </div>

        <div class="tab-content" id="macro-tab">
            <div class="macro-section">
                <div class="section-title">Transpose</div>
                <div class="macro-grid">
                    <div class="control-group">
                        <div class="control-label">Master Transpose</div>
                        <div class="control-value" id="masterTranspose">0</div>
                        <input type="range" class="slider" id="masterTransposeControl" 
                               min="-24" max="24" value="0">
                    </div>
                    <div class="control-group">
                        <div class="control-label">CH1 Transpose</div>
                        <div class="control-value" id="ch1Transpose">0</div>
                        <input type="range" class="slider" id="ch1TransposeControl" 
                               min="-24" max="24" value="0">
                    </div>
                    <div class="control-group">
                        <div class="control-label">CH2 Transpose</div>
                        <div class="control-value" id="ch2Transpose">0</div>
                        <input type="range" class="slider" id="ch2TransposeControl" 
                               min="-24" max="24" value="0">
                    </div>
                    <div class="control-group">
                        <div class="control-label">CH3 Transpose</div>
                        <div class="control-value" id="ch3Transpose">0</div>
                        <input type="range" class="slider" id="ch3TransposeControl" 
                               min="-24" max="24" value="0">
                    </div>
                    <div class="control-group">
                        <div class="control-label">CH4 Transpose</div>
                        <div class="control-value" id="ch4Transpose">0</div>
                        <input type="range" class="slider" id="ch4TransposeControl" 
                               min="-24" max="24" value="0">
                    </div>
                </div>
            </div>

            <div class="macro-section">
                <div class="section-title">Ratchets</div>
                <div class="macro-grid">
                    <div class="ratchet-control">
                        <div class="control-label">CH1 Repeats</div>
                        <div class="control-value" id="ch1RatchetRate">1</div>
                        <input type="range" class="slider" id="ch1RatchetRateControl" 
                               min="1" max="8" value="1">
                        <button class="btn" id="ch1RatchetBtn">RATCHET</button>
                    </div>
                    <div class="ratchet-control">
                        <div class="control-label">CH2 Repeats</div>
                        <div class="control-value" id="ch2RatchetRate">1</div>
                        <input type="range" class="slider" id="ch2RatchetRateControl" 
                               min="1" max="8" value="1">
                        <button class="btn" id="ch2RatchetBtn">RATCHET</button>
                    </div>
                    <div class="ratchet-control">
                        <div class="control-label">CH3 Repeats</div>
                        <div class="control-value" id="ch3RatchetRate">1</div>
                        <input type="range" class="slider" id="ch3RatchetRateControl" 
                               min="1" max="8" value="1">
                        <button class="btn" id="ch3RatchetBtn">RATCHET</button>
                    </div>
                    <div class="ratchet-control">
                        <div class="control-label">CH4 Repeats</div>
                        <div class="control-value" id="ch4RatchetRate">1</div>
                        <input type="range" class="slider" id="ch4RatchetRateControl" 
                               min="1" max="8" value="1">
                        <button class="btn" id="ch4RatchetBtn">RATCHET</button>
                    </div>
                </div>
            </div>

            <div class="macro-section">
                <div class="section-title">Freeze</div>
                <div class="macro-grid">
                    <button class="btn primary" id="masterFreezeBtn">MASTER FREEZE</button>
                    <button class="btn" id="ch1FreezeBtn">CH1 FREEZE</button>
                    <button class="btn" id="ch2FreezeBtn">CH2 FREEZE</button>
                    <button class="btn" id="ch3FreezeBtn">CH3 FREEZE</button>
                    <button class="btn" id="ch4FreezeBtn">CH4 FREEZE</button>
                </div>
            </div>

            <div class="macro-section">
                <div class="section-title">Global Macros</div>
                <div style="margin-bottom: 15px;">
                    <button class="btn" id="macroModeBtn">Mode: Momentary</button>
                </div>
                <div class="macro-controls">
                    <div class="control-group">
                        <div class="control-label">Attack</div>
                        <div class="control-value" id="macroAttack">0</div>
                        <input type="range" class="slider" id="macroAttackControl" 
                               min="-1" max="1" value="0" step="0.01">
                    </div>
                    <div class="control-group">
                        <div class="control-label">Decay</div>
                        <div class="control-value" id="macroDecay">0</div>
                        <input type="range" class="slider" id="macroDecayControl" 
                               min="-1" max="1" value="0" step="0.01">
                    </div>
                    <div class="control-group">
                        <div class="control-label">Sustain</div>
                        <div class="control-value" id="macroSustain">0</div>
                        <input type="range" class="slider" id="macroSustainControl" 
                               min="-1" max="1" value="0" step="0.01">
                    </div>
                    <div class="control-group">
                        <div class="control-label">Release</div>
                        <div class="control-value" id="macroRelease">0</div>
                        <input type="range" class="slider" id="macroReleaseControl" 
                               min="-1" max="1" value="0" step="0.01">
                    </div>
                    <div class="control-group">
                        <div class="control-label">Filter Freq</div>
                        <div class="control-value" id="macroFilterFreq">0</div>
                        <input type="range" class="slider" id="macroFilterFreqControl" 
                               min="-1" max="1" value="0" step="0.01">
                    </div>
                    <div class="control-group">
                        <div class="control-label">Resonance</div>
                        <div class="control-value" id="macroResonance">0</div>
                        <input type="range" class="slider" id="macroResonanceControl" 
                               min="-1" max="1" value="0" step="0.01">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="customScaleModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Custom Scale</div>
                <button class="modal-close" id="closeModal">×</button>
            </div>
            <div class="scale-grid" id="scaleGrid">
                ${['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'].map((note, i) => 
                    `<div class="scale-note" data-note="${i}">${note}</div>`
                ).join('')}
            </div>
            <button class="btn primary" id="applyCustomScale" style="margin-top: 20px; width: 100%;">Apply</button>
        </div>
    </div>

    <script>
        // Audio Context
        let audioContext;
        let masterGain;
        let isPlaying = false;
        let intervalId = null;

        // Sequencer Data
        const NUM_CHANNELS = 4;
        const STEPS_PER_PAGE = 8;
        const NUM_PAGES = 8;
        const CHANNEL_COLORS = ['#00C2BA', '#CE95FB', '#9765E0', '#FFD300'];
        const SCALES = {
            chromatic: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11],
            major: [0, 2, 4, 5, 7, 9, 11],
            minor: [0, 2, 3, 5, 7, 8, 10],
            majorPent: [0, 2, 4, 7, 9],
            minorPent: [0, 3, 5, 7, 10],
            harmonicMinor: [0, 2, 3, 5, 7, 8, 11],
            wholeTone: [0, 2, 4, 6, 8, 10],
            custom: [0, 2, 4, 5, 7, 9, 11]
        };

        let globalScale = 'major';
        let globalRoot = 60;
        let customScale = [0, 2, 4, 5, 7, 9, 11];

        class SequencerChannel {
            constructor(id) {
                this.id = id;
                this.steps = Array(NUM_PAGES * STEPS_PER_PAGE).fill(null).map(() => ({
                    active: false,
                    note: 60,
                    velocity: 0.7,
                    gate: 0.5,
                    ratchet: 1
                }));
                this.currentPage = 0;
                this.currentStep = 0;
                this.currentClockStep = 0;
                this.clockAccumulator = 0; // For fractional clock divisions
                this.length = 16;
                this.muted = false;
                this.mutate = 0;
                this.octave = 0;
                this.octaveDeviation = 0;
                this.transpose = 0;
                this.ratchetRate = 1;
                this.ratchetActive = false;
                this.frozen = false;
                this.frozenNote = null;
                this.clockDivision = 1.0; // 1/1 by default (1 step per global tick)
                
                this.reseed();
            }

            reseed() {
                const scale = globalScale === 'custom' ? customScale : SCALES[globalScale];
                for (let i = 0; i < this.length; i++) {
                    this.steps[i].active = Math.random() > 0.3;
                    const scaleNote = scale[Math.floor(Math.random() * scale.length)];
                    const octave = Math.floor(Math.random() * 3) - 1;
                    this.steps[i].note = globalRoot + scaleNote + (octave * 12);
                    this.steps[i].velocity = 0.4 + Math.random() * 0.6;
                    this.steps[i].gate = 0.3 + Math.random() * 0.6;
                }
            }

            mutateStep(index) {
                if (this.mutate === 0 || index >= this.length) return;
                
                const step = this.steps[index];
                if (Math.random() < this.mutate) {
                    const scale = globalScale === 'custom' ? customScale : SCALES[globalScale];
                    const scaleNote = scale[Math.floor(Math.random() * scale.length)];
                    const octave = Math.floor(Math.random() * 3) - 1;
                    step.note = globalRoot + scaleNote + (octave * 12);
                }
            }

            getTransposedNote(baseNote) {
                let note = baseNote;
                
                // Apply octave
                note += this.octave * 12;
                
                // Apply octave deviation
                if (this.octaveDeviation > 0 && Math.random() < this.octaveDeviation) {
                    note += (Math.random() > 0.5 ? 12 : -12);
                }
                
                // Apply transpose within scale
                const totalTranspose = this.transpose + masterTranspose;
                if (totalTranspose !== 0) {
                    const scale = globalScale === 'custom' ? customScale : SCALES[globalScale];
                    const noteInScale = (note - globalRoot) % 12;
                    const octaveOffset = Math.floor((note - globalRoot) / 12);
                    
                    // Find current position in scale
                    let scaleIndex = scale.indexOf(noteInScale);
                    if (scaleIndex === -1) {
                        // If note not in scale, find closest
                        scaleIndex = 0;
                        for (let i = 0; i < scale.length; i++) {
                            if (scale[i] <= noteInScale) scaleIndex = i;
                        }
                    }
                    
                    // Transpose by scale degrees
                    let newScaleIndex = scaleIndex + totalTranspose;
                    let newOctaveOffset = octaveOffset;
                    
                    while (newScaleIndex >= scale.length) {
                        newScaleIndex -= scale.length;
                        newOctaveOffset += 1;
                    }
                    while (newScaleIndex < 0) {
                        newScaleIndex += scale.length;
                        newOctaveOffset -= 1;
                    }
                    
                    note = globalRoot + scale[newScaleIndex] + (newOctaveOffset * 12);
                }
                
                return note;
            }

            snapToScale() {
                const scale = globalScale === 'custom' ? customScale : SCALES[globalScale];
                for (let i = 0; i < this.steps.length; i++) {
                    const step = this.steps[i];
                    // Get the relative note and octave
                    const relativeNote = (step.note - globalRoot) % 12;
                    const currentOctave = Math.floor((step.note - globalRoot) / 12);
                    
                    // Find closest scale note
                    let closestScaleNote = scale[0];
                    let minDistance = Math.abs(relativeNote - closestScaleNote);
                    
                    for (let j = 1; j < scale.length; j++) {
                        const distance = Math.abs(relativeNote - scale[j]);
                        if (distance < minDistance) {
                            minDistance = distance;
                            closestScaleNote = scale[j];
                        }
                    }
                    
                    step.note = globalRoot + closestScaleNote + (currentOctave * 12);
                }
            }
        }

        class Synthesizer {
            constructor(channelId) {
                this.channelId = channelId;
                this.activeNotes = new Map();
                this.gainNode = null;
                this.filter = null;
                this.envelope = {
                    attack: 0.005,  // Reduced from 0.01 to reduce clicks
                    decay: 0.1,
                    sustain: 0.7,
                    release: 0.3
                };
                this.filterEnv = {
                    amount: 0,
                    attack: 0.01,
                    decay: 0.2
                };
                this.waveform = 'sawtooth';
                this.filterFreq = 2000;
                this.filterRes = 1;
                this.outputGain = null;
            }

            init(context, destination) {
                this.context = context;
                
                this.outputGain = context.createGain();
                this.outputGain.gain.value = 1.0;
                
                this.gainNode = context.createGain();
                this.gainNode.gain.value = 0;
                
                // DC offset blocker to prevent clicks
                this.dcBlocker = context.createBiquadFilter();
                this.dcBlocker.type = 'highpass';
                this.dcBlocker.frequency.value = 10;
                this.dcBlocker.Q.value = 0.7;
                
                this.filter = context.createBiquadFilter();
                this.filter.type = 'lowpass';
                this.filter.frequency.value = this.filterFreq;
                this.filter.Q.value = this.filterRes;
                
                this.filter.connect(this.dcBlocker);
                this.dcBlocker.connect(this.gainNode);
                this.gainNode.connect(this.outputGain);
                this.outputGain.connect(destination);
            }

            noteOn(frequency, velocity, gate) {
                if (!this.context) return;

                const now = this.context.currentTime;
                
                // Smooth crossfade: ramp down existing gain slightly before new note
                if (this.activeNotes.size > 0) {
                    this.gainNode.gain.cancelScheduledValues(now);
                    this.gainNode.gain.setValueAtTime(this.gainNode.gain.value, now);
                    this.gainNode.gain.linearRampToValueAtTime(0, now + 0.003);
                    
                    // Stop old notes after fade
                    setTimeout(() => {
                        this.stopAllNotes();
                    }, 5);
                }
                
                const noteId = Date.now() + Math.random();
                
                const oscillator = this.context.createOscillator();
                oscillator.type = this.waveform;
                oscillator.frequency.value = frequency;
                
                oscillator.connect(this.filter);
                
                // Start slightly in future to avoid clicks
                const startTime = now + 0.005;
                oscillator.start(startTime);
                
                this.activeNotes.set(noteId, oscillator);

                const env = this.envelope;
                const attackStart = startTime;
                
                // Ensure smooth envelope start
                this.gainNode.gain.cancelScheduledValues(attackStart);
                this.gainNode.gain.setValueAtTime(0, attackStart);
                this.gainNode.gain.linearRampToValueAtTime(velocity, attackStart + env.attack);
                this.gainNode.gain.linearRampToValueAtTime(velocity * env.sustain, attackStart + env.attack + env.decay);

                if (this.filterEnv.amount > 0) {
                    const maxFreq = Math.min(this.filterFreq + (this.filterEnv.amount * 5000), 20000);
                    this.filter.frequency.cancelScheduledValues(attackStart);
                    this.filter.frequency.setValueAtTime(this.filterFreq, attackStart);
                    this.filter.frequency.exponentialRampToValueAtTime(maxFreq, attackStart + this.filterEnv.attack);
                    this.filter.frequency.exponentialRampToValueAtTime(this.filterFreq, attackStart + this.filterEnv.attack + this.filterEnv.decay);
                }

                const duration = (60 / tempo) * gate * 4;
                this.scheduleNoteOff(noteId, attackStart + duration);
            }

            scheduleNoteOff(noteId, time) {
                const oscillator = this.activeNotes.get(noteId);
                if (!oscillator) return;

                const now = this.context.currentTime;
                const releaseStart = Math.max(now, time);

                this.gainNode.gain.cancelScheduledValues(releaseStart);
                this.gainNode.gain.setValueAtTime(this.gainNode.gain.value, releaseStart);
                this.gainNode.gain.exponentialRampToValueAtTime(0.001, releaseStart + this.envelope.release);
                
                const stopTime = (releaseStart - now + this.envelope.release + 0.1) * 1000;
                setTimeout(() => {
                    if (this.activeNotes.has(noteId)) {
                        try {
                            oscillator.stop();
                            oscillator.disconnect();
                        } catch (e) {}
                        this.activeNotes.delete(noteId);
                    }
                }, stopTime);
            }

            stopAllNotes() {
                if (!this.context || this.activeNotes.size === 0) return;
                
                const now = this.context.currentTime;
                
                // Smooth fade out
                this.gainNode.gain.cancelScheduledValues(now);
                this.gainNode.gain.setValueAtTime(this.gainNode.gain.value, now);
                this.gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
                
                // Stop all oscillators after fade
                setTimeout(() => {
                    this.activeNotes.forEach((oscillator, noteId) => {
                        try {
                            oscillator.stop();
                            oscillator.disconnect();
                        } catch (e) {}
                    });
                    this.activeNotes.clear();
                }, 60);
            }
        }

        class MixerChannel {
            constructor(channelId) {
                this.channelId = channelId;
                this.volume = 0.7;
                this.pan = 0;
                this.lowpassFreq = 20000;
                this.lowpassRes = 0;
                this.highpassFreq = 20;
                this.highpassRes = 0;
                this.sendAmount = 0.3;
                this.muted = false;
            }

            init(context, masterOut, sendBus) {
                this.context = context;
                
                this.inputNode = context.createGain();
                this.inputNode.gain.value = 1.0;
                
                this.lowpass = context.createBiquadFilter();
                this.lowpass.type = 'lowpass';
                this.lowpass.frequency.value = this.lowpassFreq;
                this.lowpass.Q.value = this.lowpassRes;

                this.highpass = context.createBiquadFilter();
                this.highpass.type = 'highpass';
                this.highpass.frequency.value = this.highpassFreq;
                this.highpass.Q.value = this.highpassRes;

                this.gainNode = context.createGain();
                this.gainNode.gain.value = this.volume;

                this.panNode = context.createStereoPanner();
                this.panNode.pan.value = this.pan;

                this.sendGain = context.createGain();
                this.sendGain.gain.value = this.sendAmount;

                this.inputNode.connect(this.highpass);
                this.highpass.connect(this.lowpass);
                this.lowpass.connect(this.gainNode);
                this.gainNode.connect(this.panNode);
                this.panNode.connect(masterOut);
                
                this.panNode.connect(this.sendGain);
                this.sendGain.connect(sendBus);
            }
        }

        class EffectsChain {
            constructor() {
                this.saturation = { enabled: false, drive: 0.5, mix: 0.5 };
                this.delay = { enabled: false, time: 0.25, feedback: 0.5, mix: 0.3 };
                this.reverb = { enabled: false, size: 0.7, mix: 0.3 };
            }

            init(context, destination) {
                this.context = context;
                
                this.delayNode = context.createDelay(2.0);
                this.delayNode.delayTime.value = this.delay.time;
                
                this.delayFeedback = context.createGain();
                this.delayFeedback.gain.value = this.delay.feedback;
                
                this.delayWet = context.createGain();
                this.delayWet.gain.value = 0; // Start with effect off
                
                this.delayNode.connect(this.delayFeedback);
                this.delayFeedback.connect(this.delayNode);
                this.delayNode.connect(this.delayWet);

                this.reverbNode = context.createConvolver();
                this.createReverbImpulse();
                
                this.reverbWet = context.createGain();
                this.reverbWet.gain.value = 0; // Start with effect off
                
                this.reverbNode.connect(this.reverbWet);

                this.saturator = context.createWaveShaper();
                this.updateSaturationCurve();
                
                this.satWet = context.createGain();
                this.satWet.gain.value = 0; // Start with effect off
                
                this.saturator.connect(this.satWet);

                this.inputNode = context.createGain();
                this.dryNode = context.createGain();
                this.dryNode.gain.value = 1.0;
                this.outputNode = context.createGain();

                // Route: input -> saturator
                this.inputNode.connect(this.saturator);
                
                // Route: saturator -> delay -> reverb
                this.saturator.connect(this.delayNode);
                this.delayNode.connect(this.reverbNode);
                
                // Mix wet signals
                this.satWet.connect(this.outputNode);
                this.delayWet.connect(this.outputNode);
                this.reverbWet.connect(this.outputNode);
                
                // Dry signal (bypass)
                this.inputNode.connect(this.dryNode);
                this.dryNode.connect(this.outputNode);
                
                this.outputNode.connect(destination);
            }

            createReverbImpulse() {
                const sampleRate = this.context.sampleRate;
                const length = sampleRate * 2;
                const impulse = this.context.createBuffer(2, length, sampleRate);
                
                for (let channel = 0; channel < 2; channel++) {
                    const channelData = impulse.getChannelData(channel);
                    for (let i = 0; i < length; i++) {
                        channelData[i] = (Math.random() * 2 - 1) * Math.exp(-i / (sampleRate * this.reverb.size));
                    }
                }
                
                this.reverbNode.buffer = impulse;
            }

            updateSaturationCurve() {
                const samples = 1024;
                const curve = new Float32Array(samples);
                const drive = Math.max(0.01, this.saturation.drive * 10); // Prevent zero
                
                for (let i = 0; i < samples; i++) {
                    const x = (i / samples) * 2 - 1;
                    if (this.saturation.drive < 0.01) {
                        // Pass through when drive is very low
                        curve[i] = x;
                    } else {
                        curve[i] = Math.tanh(x * drive) / Math.tanh(drive);
                    }
                }
                
                this.saturator.curve = curve;
            }
        }

        let channels = [];
        let synthesizers = [];
        let mixerChannels = [];
        let effectsChain;
        let sendBus;
        let tempo = 120;
        let masterTranspose = 0;
        let macroMode = 'momentary';
        let macroBaseValues = {};
        let masterFrozen = false;

        function init() {
            for (let i = 0; i < NUM_CHANNELS; i++) {
                channels.push(new SequencerChannel(i));
                synthesizers.push(new Synthesizer(i));
                mixerChannels.push(new MixerChannel(i));
            }

            buildUI();
            setupEventListeners();
            updateCustomScaleDisplay();
        }

        function initAudio() {
            if (audioContext) return;

            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            masterGain = audioContext.createGain();
            masterGain.gain.value = 0.7;
            
            sendBus = audioContext.createGain();
            
            effectsChain = new EffectsChain();
            effectsChain.init(audioContext, masterGain);
            
            for (let i = 0; i < NUM_CHANNELS; i++) {
                mixerChannels[i].init(audioContext, masterGain, sendBus);
                synthesizers[i].init(audioContext, mixerChannels[i].inputNode);
            }
            
            sendBus.connect(effectsChain.inputNode);
            masterGain.connect(audioContext.destination);
        }

        function buildUI() {
            buildSequencerUI();
            buildSynthUI();
            buildMixerUI();
            buildFXUI();
        }

        function buildSequencerUI() {
            const container = document.getElementById('channelsContainer');
            container.innerHTML = '';

            for (let i = 0; i < NUM_CHANNELS; i++) {
                const channel = channels[i];
                const div = document.createElement('div');
                div.className = `channel ch${i + 1}`;
                div.innerHTML = `
                    <div class="channel-header">
                        <div class="channel-number">CH ${i + 1}</div>
                        <button class="channel-mute" data-channel="${i}">MUTE</button>
                    </div>
                    
                    <div class="steps-container">
                        <div class="steps-grid" id="steps${i}">
                            ${Array(STEPS_PER_PAGE).fill(0).map((_, s) => `
                                <div class="step ${channel.steps[s].active ? 'on' : ''}" 
                                     data-channel="${i}" data-step="${s}">
                                    <div class="step-circle">
                                        <div class="step-velocity-bar" style="height: ${channel.steps[s].velocity * 100}%"></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="page-dots" id="pageDots${i}">
                            ${Array(NUM_PAGES).fill(0).map((_, p) => 
                                `<div class="page-dot ${p === 0 ? 'active' : ''}" data-channel="${i}" data-page="${p}"></div>`
                            ).join('')}
                        </div>
                    </div>
                    
                    <div class="controls-row">
                        <div class="control-group">
                            <div class="control-label">Length</div>
                            <div class="control-value" id="length${i}">16</div>
                            <input type="range" class="slider length-control" 
                                   min="4" max="64" value="16" data-channel="${i}">
                        </div>
                        
                        <div class="control-group">
                            <div class="control-label">Clock Div</div>
                            <select data-channel="${i}" class="clock-control">
                                <option value="0.0625">1/16</option>
                                <option value="0.125">1/8</option>
                                <option value="0.25">1/4</option>
                                <option value="0.5">1/2</option>
                                <option value="1" selected>1/1</option>
                                <option value="2">2/1</option>
                                <option value="3">3/1</option>
                                <option value="4">4/1</option>
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <div class="control-label">Octave</div>
                            <div class="control-value" id="octave${i}">0</div>
                            <input type="range" class="slider octave-control" 
                                   min="-2" max="2" value="0" data-channel="${i}">
                        </div>
                        
                        <div class="control-group">
                            <div class="control-label">Oct Deviation</div>
                            <div class="control-value" id="octDev${i}">0%</div>
                            <input type="range" class="slider octdev-control" 
                                   min="0" max="100" value="0" data-channel="${i}">
                        </div>
                        
                        <div class="control-group">
                            <div class="control-label">Mutate</div>
                            <div class="control-value" id="mutate${i}">0%</div>
                            <input type="range" class="slider mutate-control" 
                                   min="0" max="100" value="0" data-channel="${i}">
                        </div>
                    </div>
                    
                    <button class="btn-reseed" data-channel="${i}">⟲ Reseed</button>
                `;
                container.appendChild(div);
            }
        }

        function buildSynthUI() {
            const container = document.getElementById('synthGrid');
            container.innerHTML = '';

            for (let i = 0; i < NUM_CHANNELS; i++) {
                const div = document.createElement('div');
                div.className = `synth-channel ch${i + 1}`;
                div.innerHTML = `
                    <div class="channel-header">
                        <div class="channel-number">CH ${i + 1}</div>
                    </div>
                    
                    <div class="synth-controls">
                        <div class="control-group">
                            <div class="control-label">Wave</div>
                            <select data-synth="${i}" class="wave-control">
                                <option value="sine">Sine</option>
                                <option value="triangle">Triangle</option>
                                <option value="sawtooth" selected>Sawtooth</option>
                                <option value="square">Square</option>
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <div class="control-label">Filter</div>
                            <div class="control-value" id="filterFreq${i}">2000 Hz</div>
                            <input type="range" class="slider filter-freq-control" 
                                   min="100" max="10000" value="2000" data-synth="${i}">
                        </div>
                        
                        <div class="control-group">
                            <div class="control-label">Resonance</div>
                            <div class="control-value" id="filterRes${i}">1.0</div>
                            <input type="range" class="slider filter-res-control" 
                                   min="0" max="20" value="1" data-synth="${i}" step="0.1">
                        </div>
                        
                        <div class="control-group">
                            <div class="control-label">Attack</div>
                            <div class="control-value" id="attack${i}">5 ms</div>
                            <input type="range" class="slider attack-control" 
                                   min="0.001" max="1" value="0.005" data-synth="${i}" step="0.001">
                        </div>
                        
                        <div class="control-group">
                            <div class="control-label">Decay</div>
                            <div class="control-value" id="decay${i}">100 ms</div>
                            <input type="range" class="slider decay-control" 
                                   min="0.01" max="1" value="0.1" data-synth="${i}" step="0.01">
                        </div>
                        
                        <div class="control-group">
                            <div class="control-label">Sustain</div>
                            <div class="control-value" id="sustain${i}">70%</div>
                            <input type="range" class="slider sustain-control" 
                                   min="0" max="1" value="0.7" data-synth="${i}" step="0.01">
                        </div>
                        
                        <div class="control-group">
                            <div class="control-label">Release</div>
                            <div class="control-value" id="release${i}">300 ms</div>
                            <input type="range" class="slider release-control" 
                                   min="0.01" max="2" value="0.3" data-synth="${i}" step="0.01">
                        </div>
                        
                        <div class="control-group">
                            <div class="control-label">Filter Env</div>
                            <div class="control-value" id="filterEnv${i}">0</div>
                            <input type="range" class="slider filter-env-control" 
                                   min="0" max="1" value="0" data-synth="${i}" step="0.01">
                        </div>
                    </div>
                `;
                container.appendChild(div);
            }
        }

        function buildMixerUI() {
            const container = document.getElementById('mixerGrid');
            container.innerHTML = '';

            for (let i = 0; i < NUM_CHANNELS; i++) {
                const div = document.createElement('div');
                div.className = `mixer-channel ch${i + 1}`;
                div.innerHTML = `
                    <div class="channel-number">CH ${i + 1}</div>
                    
                    <div class="fader-container">
                        <div class="control-value" id="mixVol${i}">70%</div>
                        <input type="range" class="fader" orient="vertical" 
                               min="0" max="1" value="0.7" data-mixer="${i}" step="0.01">
                    </div>
                    
                    <div class="controls-row">
                        <div class="control-group">
                            <div class="control-label">Pan</div>
                            <div class="control-value" id="mixPan${i}">C</div>
                            <input type="range" class="slider" 
                                   min="-1" max="1" value="0" data-mixer="${i}" data-param="pan" step="0.01">
                        </div>
                        
                        <div class="control-group">
                            <div class="control-label">FX Send</div>
                            <div class="control-value" id="mixSend${i}">30%</div>
                            <input type="range" class="slider" 
                                   min="0" max="1" value="0.3" data-mixer="${i}" data-param="send" step="0.01">
                        </div>
                        
                        <div class="control-group">
                            <div class="control-label">Lowpass</div>
                            <div class="control-value" id="mixLPF${i}">20k Hz</div>
                            <input type="range" class="slider" 
                                   min="100" max="20000" value="20000" data-mixer="${i}" data-param="lpf" step="10">
                        </div>
                        
                        <div class="control-group">
                            <div class="control-label">LP Res</div>
                            <div class="control-value" id="mixLPRes${i}">0</div>
                            <input type="range" class="slider" 
                                   min="0" max="20" value="0" data-mixer="${i}" data-param="lpres" step="0.1">
                        </div>
                        
                        <div class="control-group">
                            <div class="control-label">Highpass</div>
                            <div class="control-value" id="mixHPF${i}">20 Hz</div>
                            <input type="range" class="slider" 
                                   min="20" max="5000" value="20" data-mixer="${i}" data-param="hpf" step="10">
                        </div>
                        
                        <div class="control-group">
                            <div class="control-label">HP Res</div>
                            <div class="control-value" id="mixHPRes${i}">0</div>
                            <input type="range" class="slider" 
                                   min="0" max="20" value="0" data-mixer="${i}" data-param="hpres" step="0.1">
                        </div>
                    </div>
                `;
                container.appendChild(div);
            }
        }

        function buildFXUI() {
            const container = document.getElementById('fxGrid');
            container.innerHTML = `
                <div class="fx-unit">
                    <div class="fx-header">
                        <div class="fx-title">Saturation</div>
                        <button class="fx-toggle" id="satToggle">OFF</button>
                    </div>
                    
                    <div class="control-group">
                        <div class="control-label">Drive</div>
                        <div class="control-value" id="satDrive">50%</div>
                        <input type="range" class="slider" 
                               min="0" max="1" value="0.5" id="satDriveControl" step="0.01">
                    </div>
                    
                    <div class="control-group">
                        <div class="control-label">Mix</div>
                        <div class="control-value" id="satMix">50%</div>
                        <input type="range" class="slider" 
                               min="0" max="1" value="0.5" id="satMixControl" step="0.01">
                    </div>
                </div>
                
                <div class="fx-unit">
                    <div class="fx-header">
                        <div class="fx-title">Delay</div>
                        <button class="fx-toggle" id="delayToggle">OFF</button>
                    </div>
                    
                    <div class="control-group">
                        <div class="control-label">Time</div>
                        <div class="control-value" id="delayTime">250 ms</div>
                        <input type="range" class="slider" 
                               min="0.05" max="2" value="0.25" id="delayTimeControl" step="0.01">
                    </div>
                    
                    <div class="control-group">
                        <div class="control-label">Feedback</div>
                        <div class="control-value" id="delayFeedback">50%</div>
                        <input type="range" class="slider" 
                               min="0" max="0.95" value="0.5" id="delayFeedbackControl" step="0.01">
                    </div>
                    
                    <div class="control-group">
                        <div class="control-label">Mix</div>
                        <div class="control-value" id="delayMix">30%</div>
                        <input type="range" class="slider" 
                               min="0" max="1" value="0.3" id="delayMixControl" step="0.01">
                    </div>
                </div>
                
                <div class="fx-unit">
                    <div class="fx-header">
                        <div class="fx-title">Reverb</div>
                        <button class="fx-toggle" id="reverbToggle">OFF</button>
                    </div>
                    
                    <div class="control-group">
                        <div class="control-label">Size</div>
                        <div class="control-value" id="reverbSize">70%</div>
                        <input type="range" class="slider" 
                               min="0.1" max="1" value="0.7" id="reverbSizeControl" step="0.01">
                    </div>
                    
                    <div class="control-group">
                        <div class="control-label">Mix</div>
                        <div class="control-value" id="reverbMix">30%</div>
                        <input type="range" class="slider" 
                               min="0" max="1" value="0.3" id="reverbMixControl" step="0.01">
                    </div>
                </div>
            `;
        }

        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
                });
            });

            // Velocity drag control
            let draggedStep = null;
            let startY = 0;
            let startVelocity = 0;
            let isDragging = false;

            const handleStepStart = (e, touch = false) => {
                const target = touch ? document.elementFromPoint(e.touches[0].clientX, e.touches[0].clientY) : e.target;
                if (target && (target.classList.contains('step') || target.closest('.step'))) {
                    const step = target.classList.contains('step') ? target : target.closest('.step');
                    draggedStep = step;
                    startY = touch ? e.touches[0].clientY : e.clientY;
                    isDragging = false;
                    const channelId = parseInt(step.dataset.channel);
                    const stepId = parseInt(step.dataset.step);
                    const channel = channels[channelId];
                    const pageOffset = channel.currentPage * STEPS_PER_PAGE;
                    const actualStep = pageOffset + stepId;
                    startVelocity = channel.steps[actualStep].velocity;
                    if (touch) e.preventDefault();
                }
            };

            const handleStepMove = (e, touch = false) => {
                if (draggedStep) {
                    const currentY = touch ? e.touches[0].clientY : e.clientY;
                    const deltaY = startY - currentY;
                    
                    if (Math.abs(deltaY) > 5) {
                        isDragging = true;
                        const velocityChange = deltaY / 100;
                        const channelId = parseInt(draggedStep.dataset.channel);
                        const stepId = parseInt(draggedStep.dataset.step);
                        const channel = channels[channelId];
                        const pageOffset = channel.currentPage * STEPS_PER_PAGE;
                        const actualStep = pageOffset + stepId;
                        
                        channel.steps[actualStep].velocity = Math.max(0.1, Math.min(1, startVelocity + velocityChange));
                        
                        const velocityBar = draggedStep.querySelector('.step-velocity-bar');
                        if (velocityBar) {
                            velocityBar.style.height = (channel.steps[actualStep].velocity * 100) + '%';
                        }
                    }
                    if (touch) e.preventDefault();
                }
            };

            const handleStepEnd = (e, touch = false) => {
                if (draggedStep && !isDragging) {
                    const channelId = parseInt(draggedStep.dataset.channel);
                    const stepId = parseInt(draggedStep.dataset.step);
                    const channel = channels[channelId];
                    const pageOffset = channel.currentPage * STEPS_PER_PAGE;
                    const actualStep = pageOffset + stepId;
                    
                    channel.steps[actualStep].active = !channel.steps[actualStep].active;
                    draggedStep.classList.toggle('on');
                }
                draggedStep = null;
                isDragging = false;
            };

            document.addEventListener('mousedown', (e) => handleStepStart(e, false));
            document.addEventListener('touchstart', (e) => handleStepStart(e, true), { passive: false });
            document.addEventListener('mousemove', (e) => handleStepMove(e, false));
            document.addEventListener('touchmove', (e) => handleStepMove(e, true), { passive: false });
            document.addEventListener('mouseup', (e) => handleStepEnd(e, false));
            document.addEventListener('touchend', (e) => handleStepEnd(e, true));

            // Transport controls
            document.getElementById('playBtn').addEventListener('click', () => {
                initAudio();
                if (!isPlaying) {
                    startSequencer();
                } else {
                    pauseSequencer();
                }
            });

            document.getElementById('stopBtn').addEventListener('click', stopSequencer);

            document.getElementById('tempo').addEventListener('input', (e) => {
                tempo = parseInt(e.target.value);
                document.getElementById('tempoDisplay').textContent = tempo;
                if (isPlaying) {
                    stopSequencer();
                    startSequencer();
                }
            });

            document.getElementById('reseedAll').addEventListener('click', () => {
                channels.forEach(ch => ch.reseed());
                updateSequencerDisplay();
            });

            // Global scale and root
            document.getElementById('globalScale').addEventListener('change', (e) => {
                globalScale = e.target.value;
                if (globalScale === 'custom') {
                    document.getElementById('customScaleModal').classList.add('active');
                }
                // Snap all sequences to new scale
                channels.forEach(ch => ch.snapToScale());
                updateSequencerDisplay();
            });

            document.getElementById('globalRoot').addEventListener('input', (e) => {
                const val = parseInt(e.target.value);
                globalRoot = val;
                const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                const noteName = noteNames[val % 12];
                const octave = Math.floor(val / 12) - 1;
                document.getElementById('globalRootDisplay').textContent = noteName + octave;
                // Snap all sequences to new root
                channels.forEach(ch => ch.snapToScale());
                updateSequencerDisplay();
            });

            // Custom scale modal
            document.getElementById('closeModal').addEventListener('click', () => {
                document.getElementById('customScaleModal').classList.remove('active');
            });

            document.getElementById('applyCustomScale').addEventListener('click', () => {
                document.getElementById('customScaleModal').classList.remove('active');
                // Snap all sequences to new custom scale
                channels.forEach(ch => ch.snapToScale());
                updateSequencerDisplay();
            });

            document.querySelectorAll('.scale-note').forEach(note => {
                note.addEventListener('click', () => {
                    note.classList.toggle('active');
                    updateCustomScale();
                });
            });

            // Master transpose
            document.getElementById('masterTransposeControl').addEventListener('input', (e) => {
                masterTranspose = parseInt(e.target.value);
                document.getElementById('masterTranspose').textContent = masterTranspose > 0 ? '+' + masterTranspose : masterTranspose;
            });

            // Individual transposes
            for (let i = 0; i < NUM_CHANNELS; i++) {
                document.getElementById(`ch${i + 1}TransposeControl`).addEventListener('input', (e) => {
                    const val = parseInt(e.target.value);
                    channels[i].transpose = val;
                    document.getElementById(`ch${i + 1}Transpose`).textContent = val > 0 ? '+' + val : val;
                });
            }

            // Ratchets
            for (let i = 0; i < NUM_CHANNELS; i++) {
                document.getElementById(`ch${i + 1}RatchetRateControl`).addEventListener('input', (e) => {
                    const val = parseInt(e.target.value);
                    channels[i].ratchetRate = val;
                    document.getElementById(`ch${i + 1}RatchetRate`).textContent = val;
                });

                const ratchetBtn = document.getElementById(`ch${i + 1}RatchetBtn`);
                ratchetBtn.addEventListener('mousedown', () => {
                    channels[i].ratchetActive = true;
                    ratchetBtn.classList.add('active');
                });
                ratchetBtn.addEventListener('mouseup', () => {
                    channels[i].ratchetActive = false;
                    ratchetBtn.classList.remove('active');
                });
                ratchetBtn.addEventListener('mouseleave', () => {
                    channels[i].ratchetActive = false;
                    ratchetBtn.classList.remove('active');
                });
            }

            // Freeze buttons
            document.getElementById('masterFreezeBtn').addEventListener('mousedown', () => {
                masterFrozen = true;
                document.getElementById('masterFreezeBtn').classList.add('active');
            });
            document.getElementById('masterFreezeBtn').addEventListener('mouseup', () => {
                masterFrozen = false;
                document.getElementById('masterFreezeBtn').classList.remove('active');
            });
            document.getElementById('masterFreezeBtn').addEventListener('mouseleave', () => {
                masterFrozen = false;
                document.getElementById('masterFreezeBtn').classList.remove('active');
            });

            for (let i = 0; i < NUM_CHANNELS; i++) {
                const freezeBtn = document.getElementById(`ch${i + 1}FreezeBtn`);
                freezeBtn.addEventListener('mousedown', () => {
                    channels[i].frozen = true;
                    freezeBtn.classList.add('active');
                });
                freezeBtn.addEventListener('mouseup', () => {
                    channels[i].frozen = false;
                    channels[i].frozenNote = null;
                    freezeBtn.classList.remove('active');
                });
                freezeBtn.addEventListener('mouseleave', () => {
                    channels[i].frozen = false;
                    channels[i].frozenNote = null;
                    freezeBtn.classList.remove('active');
                });
            }

            // Macro mode
            document.getElementById('macroModeBtn').addEventListener('click', (e) => {
                const oldMode = macroMode;
                macroMode = macroMode === 'momentary' ? 'persistent' : 'momentary';
                e.target.textContent = 'Mode: ' + (macroMode === 'momentary' ? 'Momentary' : 'Persistent');
                
                // Reset all macro controls when switching modes
                macroBaseValues = {};
                const macroParams = ['Attack', 'Decay', 'Sustain', 'Release', 'FilterFreq', 'Resonance'];
                macroParams.forEach(param => {
                    const control = document.getElementById(`macro${param}Control`);
                    const display = document.getElementById(`macro${param}`);
                    control.value = 0;
                    display.textContent = '0';
                });
            });

            // Macro controls
            const macroParams = ['Attack', 'Decay', 'Sustain', 'Release', 'FilterFreq', 'Resonance'];
            macroParams.forEach(param => {
                const control = document.getElementById(`macro${param}Control`);
                const display = document.getElementById(`macro${param}`);
                
                let isMouseDown = false;
                
                control.addEventListener('mousedown', () => {
                    isMouseDown = true;
                    if (macroMode === 'momentary') {
                        storeMacroBaseValues(param.toLowerCase());
                    }
                });
                
                control.addEventListener('mouseup', () => {
                    isMouseDown = false;
                    if (macroMode === 'momentary') {
                        resetMacroValues(param.toLowerCase());
                        control.value = 0;
                        display.textContent = '0';
                    }
                });
                
                control.addEventListener('mouseleave', () => {
                    if (isMouseDown && macroMode === 'momentary') {
                        isMouseDown = false;
                        resetMacroValues(param.toLowerCase());
                        control.value = 0;
                        display.textContent = '0';
                    }
                });

                control.addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    display.textContent = val > 0 ? '+' + (val * 100).toFixed(0) + '%' : (val * 100).toFixed(0) + '%';
                    
                    if (macroMode === 'momentary' && isMouseDown) {
                        applyMacro(param.toLowerCase(), val, false);
                    } else if (macroMode === 'persistent') {
                        if (!macroBaseValues[param.toLowerCase()]) {
                            storeMacroBaseValues(param.toLowerCase());
                        }
                        applyMacro(param.toLowerCase(), val, true);
                    }
                });
            });

            // Page navigation
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('page-dot')) {
                    const channelId = parseInt(e.target.dataset.channel);
                    const page = parseInt(e.target.dataset.page);
                    channels[channelId].currentPage = page;
                    updateSequencerDisplay();
                }

                if (e.target.classList.contains('channel-mute')) {
                    const channelId = parseInt(e.target.dataset.channel);
                    channels[channelId].muted = !channels[channelId].muted;
                    e.target.classList.toggle('muted');
                    e.target.textContent = channels[channelId].muted ? 'UNMUTE' : 'MUTE';
                }

                if (e.target.classList.contains('btn-reseed')) {
                    const channelId = parseInt(e.target.dataset.channel);
                    if (channelId !== undefined) {
                        channels[channelId].reseed();
                        updateSequencerDisplay();
                    }
                }

                if (e.target.id === 'satToggle') {
                    if (effectsChain) {
                        effectsChain.saturation.enabled = !effectsChain.saturation.enabled;
                        e.target.classList.toggle('active');
                        e.target.textContent = effectsChain.saturation.enabled ? 'ON' : 'OFF';
                        // Update wet gain based on enabled state
                        if (effectsChain.satWet) {
                            effectsChain.satWet.gain.value = effectsChain.saturation.enabled ? effectsChain.saturation.mix : 0;
                        }
                    }
                }
                if (e.target.id === 'delayToggle') {
                    if (effectsChain) {
                        effectsChain.delay.enabled = !effectsChain.delay.enabled;
                        e.target.classList.toggle('active');
                        e.target.textContent = effectsChain.delay.enabled ? 'ON' : 'OFF';
                        // Update wet gain based on enabled state
                        if (effectsChain.delayWet) {
                            effectsChain.delayWet.gain.value = effectsChain.delay.enabled ? effectsChain.delay.mix : 0;
                        }
                    }
                }
                if (e.target.id === 'reverbToggle') {
                    if (effectsChain) {
                        effectsChain.reverb.enabled = !effectsChain.reverb.enabled;
                        e.target.classList.toggle('active');
                        e.target.textContent = effectsChain.reverb.enabled ? 'ON' : 'OFF';
                        // Update wet gain based on enabled state
                        if (effectsChain.reverbWet) {
                            effectsChain.reverbWet.gain.value = effectsChain.reverb.enabled ? effectsChain.reverb.mix : 0;
                        }
                    }
                }
            });

            // Sequencer controls
            document.addEventListener('input', (e) => {
                if (e.target.classList.contains('length-control')) {
                    const channelId = parseInt(e.target.dataset.channel);
                    const val = parseInt(e.target.value);
                    channels[channelId].length = val;
                    document.getElementById(`length${channelId}`).textContent = val;
                }
                
                if (e.target.classList.contains('octave-control')) {
                    const channelId = parseInt(e.target.dataset.channel);
                    const val = parseInt(e.target.value);
                    channels[channelId].octave = val;
                    document.getElementById(`octave${channelId}`).textContent = val > 0 ? '+' + val : val;
                }

                if (e.target.classList.contains('octdev-control')) {
                    const channelId = parseInt(e.target.dataset.channel);
                    const val = parseInt(e.target.value);
                    channels[channelId].octaveDeviation = val / 100;
                    document.getElementById(`octDev${channelId}`).textContent = val + '%';
                }

                if (e.target.classList.contains('mutate-control')) {
                    const channelId = parseInt(e.target.dataset.channel);
                    const val = parseInt(e.target.value);
                    channels[channelId].mutate = val / 100;
                    document.getElementById(`mutate${channelId}`).textContent = val + '%';
                }
            });
            
            document.addEventListener('change', (e) => {
                if (e.target.classList.contains('clock-control')) {
                    const channelId = parseInt(e.target.dataset.channel);
                    const val = parseFloat(e.target.value);
                    channels[channelId].clockDivision = val;
                    channels[channelId].clockAccumulator = 0; // Reset accumulator
                }
                
                // Synth controls
                if (e.target.classList.contains('wave-control')) {
                    const synthId = parseInt(e.target.dataset.synth);
                    synthesizers[synthId].waveform = e.target.value;
                }
            });
            
            document.addEventListener('input', (e) => {
                if (e.target.classList.contains('filter-freq-control')) {
                    const synthId = parseInt(e.target.dataset.synth);
                    const val = parseInt(e.target.value);
                    synthesizers[synthId].filterFreq = val;
                    if (synthesizers[synthId].filter) {
                        synthesizers[synthId].filter.frequency.value = val;
                    }
                    document.getElementById(`filterFreq${synthId}`).textContent = val + ' Hz';
                }

                if (e.target.classList.contains('filter-res-control')) {
                    const synthId = parseInt(e.target.dataset.synth);
                    const val = parseFloat(e.target.value);
                    synthesizers[synthId].filterRes = val;
                    if (synthesizers[synthId].filter) {
                        synthesizers[synthId].filter.Q.value = val;
                    }
                    document.getElementById(`filterRes${synthId}`).textContent = val.toFixed(1);
                }

                if (e.target.classList.contains('filter-env-control')) {
                    const synthId = parseInt(e.target.dataset.synth);
                    const val = parseFloat(e.target.value);
                    synthesizers[synthId].filterEnv.amount = val;
                    document.getElementById(`filterEnv${synthId}`).textContent = (val * 100).toFixed(0) + '%';
                }

                if (e.target.classList.contains('attack-control')) {
                    const synthId = parseInt(e.target.dataset.synth);
                    const val = parseFloat(e.target.value);
                    synthesizers[synthId].envelope.attack = val;
                    document.getElementById(`attack${synthId}`).textContent = (val * 1000).toFixed(0) + ' ms';
                }

                if (e.target.classList.contains('decay-control')) {
                    const synthId = parseInt(e.target.dataset.synth);
                    const val = parseFloat(e.target.value);
                    synthesizers[synthId].envelope.decay = val;
                    document.getElementById(`decay${synthId}`).textContent = (val * 1000).toFixed(0) + ' ms';
                }

                if (e.target.classList.contains('sustain-control')) {
                    const synthId = parseInt(e.target.dataset.synth);
                    const val = parseFloat(e.target.value);
                    synthesizers[synthId].envelope.sustain = val;
                    document.getElementById(`sustain${synthId}`).textContent = (val * 100).toFixed(0) + '%';
                }

                if (e.target.classList.contains('release-control')) {
                    const synthId = parseInt(e.target.dataset.synth);
                    const val = parseFloat(e.target.value);
                    synthesizers[synthId].envelope.release = val;
                    document.getElementById(`release${synthId}`).textContent = (val * 1000).toFixed(0) + ' ms';
                }

                // Mixer controls
                if (e.target.classList.contains('fader')) {
                    const mixerId = parseInt(e.target.dataset.mixer);
                    const val = parseFloat(e.target.value);
                    const mixer = mixerChannels[mixerId];
                    mixer.volume = val;
                    if (mixer.gainNode) mixer.gainNode.gain.value = val;
                    document.getElementById(`mixVol${mixerId}`).textContent = (val * 100).toFixed(0) + '%';
                }

                if (e.target.dataset.mixer !== undefined && e.target.dataset.param === 'pan') {
                    const mixerId = parseInt(e.target.dataset.mixer);
                    const val = parseFloat(e.target.value);
                    const mixer = mixerChannels[mixerId];
                    mixer.pan = val;
                    if (mixer.panNode) mixer.panNode.pan.value = val;
                    document.getElementById(`mixPan${mixerId}`).textContent = 
                        val < -0.1 ? 'L' + Math.abs(val * 100).toFixed(0) : 
                        val > 0.1 ? 'R' + (val * 100).toFixed(0) : 'C';
                }

                if (e.target.dataset.mixer !== undefined && e.target.dataset.param === 'send') {
                    const mixerId = parseInt(e.target.dataset.mixer);
                    const val = parseFloat(e.target.value);
                    const mixer = mixerChannels[mixerId];
                    mixer.sendAmount = val;
                    if (mixer.sendGain) mixer.sendGain.gain.value = val;
                    document.getElementById(`mixSend${mixerId}`).textContent = (val * 100).toFixed(0) + '%';
                }

                if (e.target.dataset.mixer !== undefined && e.target.dataset.param === 'lpf') {
                    const mixerId = parseInt(e.target.dataset.mixer);
                    const val = parseFloat(e.target.value);
                    const mixer = mixerChannels[mixerId];
                    mixer.lowpassFreq = val;
                    if (mixer.lowpass) mixer.lowpass.frequency.value = val;
                    document.getElementById(`mixLPF${mixerId}`).textContent = 
                        val >= 1000 ? (val / 1000).toFixed(1) + 'k Hz' : val.toFixed(0) + ' Hz';
                }

                if (e.target.dataset.mixer !== undefined && e.target.dataset.param === 'lpres') {
                    const mixerId = parseInt(e.target.dataset.mixer);
                    const val = parseFloat(e.target.value);
                    const mixer = mixerChannels[mixerId];
                    mixer.lowpassRes = val;
                    if (mixer.lowpass) mixer.lowpass.Q.value = val;
                    document.getElementById(`mixLPRes${mixerId}`).textContent = val.toFixed(1);
                }

                if (e.target.dataset.mixer !== undefined && e.target.dataset.param === 'hpf') {
                    const mixerId = parseInt(e.target.dataset.mixer);
                    const val = parseFloat(e.target.value);
                    const mixer = mixerChannels[mixerId];
                    mixer.highpassFreq = val;
                    if (mixer.highpass) mixer.highpass.frequency.value = val;
                    document.getElementById(`mixHPF${mixerId}`).textContent = 
                        val >= 1000 ? (val / 1000).toFixed(1) + 'k Hz' : val.toFixed(0) + ' Hz';
                }

                if (e.target.dataset.mixer !== undefined && e.target.dataset.param === 'hpres') {
                    const mixerId = parseInt(e.target.dataset.mixer);
                    const val = parseFloat(e.target.value);
                    const mixer = mixerChannels[mixerId];
                    mixer.highpassRes = val;
                    if (mixer.highpass) mixer.highpass.Q.value = val;
                    document.getElementById(`mixHPRes${mixerId}`).textContent = val.toFixed(1);
                }

                // FX controls
                if (e.target.id === 'satDriveControl') {
                    const val = parseFloat(e.target.value);
                    if (effectsChain) {
                        effectsChain.saturation.drive = val;
                        effectsChain.updateSaturationCurve();
                    }
                    document.getElementById('satDrive').textContent = (val * 100).toFixed(0) + '%';
                }

                if (e.target.id === 'satMixControl') {
                    const val = parseFloat(e.target.value);
                    if (effectsChain) {
                        effectsChain.saturation.mix = val;
                        if (effectsChain.satWet && effectsChain.saturation.enabled) {
                            effectsChain.satWet.gain.value = val;
                        }
                    }
                    document.getElementById('satMix').textContent = (val * 100).toFixed(0) + '%';
                }

                if (e.target.id === 'delayTimeControl') {
                    const val = parseFloat(e.target.value);
                    if (effectsChain) {
                        effectsChain.delay.time = val;
                        effectsChain.delayNode.delayTime.value = val;
                    }
                    document.getElementById('delayTime').textContent = (val * 1000).toFixed(0) + ' ms';
                }

                if (e.target.id === 'delayFeedbackControl') {
                    const val = parseFloat(e.target.value);
                    if (effectsChain) {
                        effectsChain.delay.feedback = val;
                        effectsChain.delayFeedback.gain.value = val;
                    }
                    document.getElementById('delayFeedback').textContent = (val * 100).toFixed(0) + '%';
                }

                if (e.target.id === 'delayMixControl') {
                    const val = parseFloat(e.target.value);
                    if (effectsChain) {
                        effectsChain.delay.mix = val;
                        if (effectsChain.delayWet && effectsChain.delay.enabled) {
                            effectsChain.delayWet.gain.value = val;
                        }
                    }
                    document.getElementById('delayMix').textContent = (val * 100).toFixed(0) + '%';
                }

                if (e.target.id === 'reverbSizeControl') {
                    const val = parseFloat(e.target.value);
                    if (effectsChain) {
                        effectsChain.reverb.size = val;
                        effectsChain.createReverbImpulse();
                    }
                    document.getElementById('reverbSize').textContent = (val * 100).toFixed(0) + '%';
                }

                if (e.target.id === 'reverbMixControl') {
                    const val = parseFloat(e.target.value);
                    if (effectsChain) {
                        effectsChain.reverb.mix = val;
                        if (effectsChain.reverbWet && effectsChain.reverb.enabled) {
                            effectsChain.reverbWet.gain.value = val;
                        }
                    }
                    document.getElementById('reverbMix').textContent = (val * 100).toFixed(0) + '%';
                }
            });
        }

        function updateCustomScale() {
            customScale = [];
            document.querySelectorAll('.scale-note.active').forEach(note => {
                customScale.push(parseInt(note.dataset.note));
            });
            customScale.sort((a, b) => a - b);
            SCALES.custom = customScale;
        }

        function updateCustomScaleDisplay() {
            document.querySelectorAll('.scale-note').forEach((note, i) => {
                if (customScale.includes(i)) {
                    note.classList.add('active');
                }
            });
        }

        function storeMacroBaseValues(param) {
            macroBaseValues[param] = synthesizers.map(synth => {
                switch(param) {
                    case 'attack': return synth.envelope.attack;
                    case 'decay': return synth.envelope.decay;
                    case 'sustain': return synth.envelope.sustain;
                    case 'release': return synth.envelope.release;
                    case 'filterfreq': return synth.filterFreq;
                    case 'resonance': return synth.filterRes;
                }
            });
        }

        function applyMacro(param, value, persistent) {
            synthesizers.forEach((synth, i) => {
                let baseValue;
                
                if (persistent) {
                    // In persistent mode, always use current value as base
                    baseValue = getCurrentValue(synth, param);
                } else {
                    // In momentary mode, use stored base value
                    baseValue = macroBaseValues[param][i];
                }
                
                let newValue;
                switch(param) {
                    case 'attack':
                        newValue = Math.max(0.001, Math.min(1, baseValue * (1 + value)));
                        synth.envelope.attack = newValue;
                        if (persistent) {
                            const slider = document.querySelector(`[data-synth="${i}"].attack-control`);
                            if (slider) slider.value = newValue;
                            document.getElementById(`attack${i}`).textContent = (newValue * 1000).toFixed(0) + ' ms';
                        }
                        break;
                    case 'decay':
                        newValue = Math.max(0.01, Math.min(1, baseValue * (1 + value)));
                        synth.envelope.decay = newValue;
                        if (persistent) {
                            const slider = document.querySelector(`[data-synth="${i}"].decay-control`);
                            if (slider) slider.value = newValue;
                            document.getElementById(`decay${i}`).textContent = (newValue * 1000).toFixed(0) + ' ms';
                        }
                        break;
                    case 'sustain':
                        newValue = Math.max(0, Math.min(1, baseValue * (1 + value)));
                        synth.envelope.sustain = newValue;
                        if (persistent) {
                            const slider = document.querySelector(`[data-synth="${i}"].sustain-control`);
                            if (slider) slider.value = newValue;
                            document.getElementById(`sustain${i}`).textContent = (newValue * 100).toFixed(0) + '%';
                        }
                        break;
                    case 'release':
                        newValue = Math.max(0.01, Math.min(2, baseValue * (1 + value)));
                        synth.envelope.release = newValue;
                        if (persistent) {
                            const slider = document.querySelector(`[data-synth="${i}"].release-control`);
                            if (slider) slider.value = newValue;
                            document.getElementById(`release${i}`).textContent = (newValue * 1000).toFixed(0) + ' ms';
                        }
                        break;
                    case 'filterfreq':
                        newValue = Math.max(100, Math.min(10000, baseValue * (1 + value)));
                        synth.filterFreq = newValue;
                        if (synth.filter) synth.filter.frequency.value = newValue;
                        if (persistent) {
                            const slider = document.querySelector(`[data-synth="${i}"].filter-freq-control`);
                            if (slider) slider.value = newValue;
                            document.getElementById(`filterFreq${i}`).textContent = newValue.toFixed(0) + ' Hz';
                        }
                        break;
                    case 'resonance':
                        newValue = Math.max(0, Math.min(20, baseValue * (1 + value)));
                        synth.filterRes = newValue;
                        if (synth.filter) synth.filter.Q.value = newValue;
                        if (persistent) {
                            const slider = document.querySelector(`[data-synth="${i}"].filter-res-control`);
                            if (slider) slider.value = newValue;
                            document.getElementById(`filterRes${i}`).textContent = newValue.toFixed(1);
                        }
                        break;
                }
            });
        }

        function getCurrentValue(synth, param) {
            switch(param) {
                case 'attack': return synth.envelope.attack;
                case 'decay': return synth.envelope.decay;
                case 'sustain': return synth.envelope.sustain;
                case 'release': return synth.envelope.release;
                case 'filterfreq': return synth.filterFreq;
                case 'resonance': return synth.filterRes;
            }
        }

        function resetMacroValues(param) {
            if (!macroBaseValues[param]) return;
            
            synthesizers.forEach((synth, i) => {
                const baseValue = macroBaseValues[param][i];
                switch(param) {
                    case 'attack':
                        synth.envelope.attack = baseValue;
                        break;
                    case 'decay':
                        synth.envelope.decay = baseValue;
                        break;
                    case 'sustain':
                        synth.envelope.sustain = baseValue;
                        break;
                    case 'release':
                        synth.envelope.release = baseValue;
                        break;
                    case 'filterfreq':
                        synth.filterFreq = baseValue;
                        if (synth.filter) synth.filter.frequency.value = baseValue;
                        break;
                    case 'resonance':
                        synth.filterRes = baseValue;
                        if (synth.filter) synth.filter.Q.value = baseValue;
                        break;
                }
            });
        }

        function startSequencer() {
            if (!audioContext) return;
            
            isPlaying = true;
            const playBtn = document.getElementById('playBtn');
            playBtn.textContent = '⏸ Pause';
            playBtn.classList.add('playing');
            
            const stepTime = (60 / tempo) * 1000 / 4;
            
            intervalId = setInterval(() => {
                playStep();
            }, stepTime);
        }

        function pauseSequencer() {
            isPlaying = false;
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
            const playBtn = document.getElementById('playBtn');
            playBtn.textContent = '▶ Play';
            playBtn.classList.remove('playing');
        }

        function stopSequencer() {
            pauseSequencer();
            
            channels.forEach(ch => ch.currentStep = 0);
            
            document.querySelectorAll('.step.current').forEach(el => {
                el.classList.remove('current');
            });
            
            if (synthesizers) {
                synthesizers.forEach(synth => {
                    if (synth.stopAllNotes) {
                        synth.stopAllNotes();
                    }
                });
            }
            
            updateSequencerDisplay();
        }

        function playStep() {
            if (!audioContext) return;
            
            channels.forEach((channel, channelId) => {
                if (channel.muted) return;

                // Accumulate clock steps (clockDivision is steps per global tick)
                channel.clockAccumulator += channel.clockDivision;
                
                // Play for each integer step accumulated
                while (channel.clockAccumulator >= 1.0) {
                    channel.clockAccumulator -= 1.0;
                    
                    // Check if frozen
                    if (masterFrozen || channel.frozen) {
                        if (channel.frozenNote) {
                            const freq = midiToFreq(channel.frozenNote);
                            synthesizers[channelId].noteOn(freq, 0.7, 0.5);
                        }
                        updateStepVisual(channelId, channel.currentStep);
                        if (!masterFrozen) {
                            channel.currentStep = (channel.currentStep + 1) % channel.length;
                        }
                        continue;
                    }

                    const step = channel.steps[channel.currentStep];
                    
                    if (channel.mutate > 0) {
                        channel.mutateStep(channel.currentStep);
                    }

                    if (step.active) {
                        const transposedNote = channel.getTransposedNote(step.note);
                        
                        // Store for freeze
                        channel.frozenNote = transposedNote;
                        
                        const freq = midiToFreq(transposedNote);
                        synthesizers[channelId].noteOn(freq, step.velocity, step.gate);

                        // Ratchet logic - play additional repeats
                        if (channel.ratchetActive && channel.ratchetRate > 1) {
                            const ratchetDelay = (60 / tempo) * 1000 / 4 / channel.ratchetRate / channel.clockDivision;
                            // Capture variables in closure to prevent them from changing
                            const capturedFreq = freq;
                            const capturedVelocity = step.velocity;
                            const capturedGate = step.gate;
                            const capturedChannelId = channelId;
                            
                            for (let r = 1; r < channel.ratchetRate; r++) {
                                ((repeatIndex) => {
                                    setTimeout(() => {
                                        synthesizers[capturedChannelId].noteOn(capturedFreq, capturedVelocity * 0.7, capturedGate * 0.5);
                                    }, ratchetDelay * repeatIndex);
                                })(r);
                            }
                        }
                    }

                    updateStepVisual(channelId, channel.currentStep);
                    
                    if (!masterFrozen) {
                        channel.currentStep = (channel.currentStep + 1) % channel.length;
                    }
                }
            });
        }

        function updateStepVisual(channelId, stepIndex) {
            const channel = channels[channelId];
            const page = Math.floor(stepIndex / STEPS_PER_PAGE);
            
            if (page === channel.currentPage) {
                document.querySelectorAll(`#steps${channelId} .step`).forEach(el => {
                    el.classList.remove('current');
                });
                
                const localStep = stepIndex % STEPS_PER_PAGE;
                const stepEl = document.querySelector(`#steps${channelId} [data-step="${localStep}"]`);
                if (stepEl) {
                    stepEl.classList.add('current');
                }
            }
        }

        function updateSequencerDisplay() {
            channels.forEach((channel, channelId) => {
                const stepsContainer = document.getElementById(`steps${channelId}`);
                if (!stepsContainer) return;

                const pageOffset = channel.currentPage * STEPS_PER_PAGE;
                
                stepsContainer.innerHTML = '';
                for (let i = 0; i < STEPS_PER_PAGE; i++) {
                    const stepIndex = pageOffset + i;
                    const step = channel.steps[stepIndex];
                    const div = document.createElement('div');
                    div.className = `step ${step.active ? 'on' : ''}`;
                    div.dataset.channel = channelId;
                    div.dataset.step = i;
                    div.innerHTML = `
                        <div class="step-circle">
                            <div class="step-velocity-bar" style="height: ${step.velocity * 100}%"></div>
                        </div>
                    `;
                    stepsContainer.appendChild(div);
                }

                document.querySelectorAll(`#pageDots${channelId} .page-dot`).forEach((dot, i) => {
                    dot.classList.toggle('active', i === channel.currentPage);
                });
            });
        }

        function midiToFreq(midi) {
            return 440 * Math.pow(2, (midi - 69) / 12);
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>
